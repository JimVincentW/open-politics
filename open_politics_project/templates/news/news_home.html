{% extends "base.html" %}
{% load static %}
{% block news_home %}

{% include 'news/hero_tools.html' %}

<!-- Include HTMX -->
<script src="https://unpkg.com/htmx.org"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        let timer;
        const loadingSpinner = document.getElementById('loading');

        // Helper function to show and hide the loading spinner
        function showLoadingSpinner() {
            loadingSpinner.style.display = 'block';
        }

        function hideLoadingSpinner() {
            loadingSpinner.style.display = 'none';
        }

        // Helper function to render markdown content
        function renderMarkdown(contentId) {
            const content = document.getElementById(contentId);
            content.innerHTML = marked.parse(content.textContent);  // Use marked.parse() here
        }

        // Listener for search form
        document.getElementById('search-form').querySelector('input[name="query"]').addEventListener('input', function() {
            clearTimeout(timer);
            timer = setTimeout(async function() {
                showLoadingSpinner(); // Show spinner when fetching data

                let queryValue = encodeURIComponent(document.getElementById('search-form').querySelector('input[name="query"]').value);
                
                // Fetch news results
                let newsResponse = await fetch('/news_synopsis/?query=' + queryValue);
                if (newsResponse.ok) {
                    let newsHTML = await newsResponse.text();
                    document.getElementById('news-results').innerHTML = newsHTML;
                    renderMarkdown('synopsis-content');  // Parse and render markdown for synopsis
                }

                // Fetch actors results
                let actorsResponse = await fetch('/news_actors/?query=' + queryValue);
                if (actorsResponse.ok) {
                    let actorsHTML = await actorsResponse.text();
                    document.getElementById('actors-results').innerHTML = actorsHTML;
                    renderMarkdown('actors-content');  // Parse and render markdown for actors
                }
                
                hideLoadingSpinner(); // Hide spinner when data is loaded
            }, 500);
        });

        // Handle the streamed response
        document.body.addEventListener('htmx:afterOnLoad', function(event) {
            let content = event.detail.value;
            // Update the DOM with the streamed content
            document.getElementById('streamed-results').innerHTML += content;
        });
    });
    document.body.addEventListener('htmx:configRequest', function(event) {
        var csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        event.detail.headers['X-CSRFToken'] = csrfToken;
    });
</script>

{% endblock %}

