{% extends "base.html" %}
{% load custom_filters %}

{% block content %}

<style> 

  @keyframes spin { to { transform: rotate(360deg); } } 
  @keyframes color-change { 
    0% { border-top-color: #3498db; } 
    25% { border-top-color: #e74c3c; } 
    50% { border-top-color: #f1c40f; } 
    75% { border-top-color: #2ecc71; } 
    100% { border-top-color: #3498db; } 
  } 

  .spinner { 
    position: absolute; 
    justify-self: center; 
    top: 50%; 
    left: 50%; 
    transform: translate(-50%, -50%); 
    z-index: 1000; 
  } 

  .loader { 
    border: 5px solid #f3f3f3; 
    border-radius: 50%; 
    border-top: 5px solid #3498db; 
    width: 50px; 
    height: 50px; 
    animation: spin 2s linear infinite, color-change 4s ease-in-out infinite; 
  }

  /* Image display styles */
  .article-image {
    width: 100%;
    height: 80px; /* Set a fixed height, or adjust as needed */
    background-size: cover;
    background-position: center;
    border-radius: 8px;
    
  }

  #chartdiv {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh; /* Ensure it covers the full viewport height */
    z-index: -1; /* Initially in the background */
  }
  
  #dashboard {
    z-index: 1002; /* Initially in the foreground */
  }

  #toggleGlobe {
    z-index: 1003 !important;
    position: fixed; /* Fixed position */
    bottom: 20px; /* Positioning from bottom */
    right: 20px; /* Positioning from right */
  }
  @media (max-width: 768px) { /* Adjust this value based on your mobile breakpoint */
    .mobile-hide {
      display: none;
    }
  }
</style>

</style> 

<div id="chartdiv"></div> 

<h1 class="text-3xl font-bold text-gray-900 dark:text-white text-center my-4 opacity-90">Focus Dashboard</h1>

<div id="chartdiv"></div>
<button id="toggleGlobe" class="toggle-button bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full">Toggle Globe</button>
<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/map.js"></script>
<script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
<script> 
  document.body.addEventListener('htmx:beforeRequest', function(event) { 
    event.target.querySelector('.spinner').classList.remove('hidden'); 
  });

  document.body.addEventListener('htmx:afterRequest', function(event) {
    event.target.querySelector('.spinner').classList.add('hidden');
  });

  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      const context = this;
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(context, args), wait);
    };
  }
  const form = document.querySelector('form');
  form.addEventListener('submit', debounce(function() {
    // Submit the form
    this.submit();
  }, 300));
</script> 
<script>
  am5.ready(function() {
  
  // Create root element
  // https://www.amcharts.com/docs/v5/getting-started/#Root_element
  var root = am5.Root.new("chartdiv");
  
  
  // Set themes
  // https://www.amcharts.com/docs/v5/concepts/themes/
  root.setThemes([
    am5themes_Animated.new(root)
  ]);
  
  
  // Create the map chart
  // https://www.amcharts.com/docs/v5/charts/map-chart/
  var chart = root.container.children.push(am5map.MapChart.new(root, {
    panX: "rotateX",
    panY: "rotateY",
    projection: am5map.geoOrthographic(),
    paddingBottom: 20,
    paddingTop: 20,
    paddingLeft: 20,
    paddingRight: 20
  }));
  
  
  // Create main polygon series for countries
  // https://www.amcharts.com/docs/v5/charts/map-chart/map-polygon-series/
  var polygonSeries = chart.series.push(am5map.MapPolygonSeries.new(root, {
    geoJSON: am5geodata_worldLow
  }));
  
  polygonSeries.mapPolygons.template.setAll({
    tooltipText: "{name}",
    toggleKey: "active",
    interactive: true
  });
  
  polygonSeries.mapPolygons.template.states.create("hover", {
    fill: root.interfaceColors.get("primaryButtonHover")
  });
  
  
  // Create series for background fill
  // https://www.amcharts.com/docs/v5/charts/map-chart/map-polygon-series/#Background_polygon
  var backgroundSeries = chart.series.push(am5map.MapPolygonSeries.new(root, {}));
  backgroundSeries.mapPolygons.template.setAll({
    fill: root.interfaceColors.get("alternativeBackground"),
    fillOpacity: 0.1,
    strokeOpacity: 0
  });
  backgroundSeries.data.push({
    geometry: am5map.getGeoRectangle(90, 180, -90, -180)
  });
  
  
  // Create graticule series
  // https://www.amcharts.com/docs/v5/charts/map-chart/graticule-series/
  var graticuleSeries = chart.series.push(am5map.GraticuleSeries.new(root, {}));
  graticuleSeries.mapLines.template.setAll({ strokeOpacity: 0.1, stroke: root.interfaceColors.get("alternativeBackground") })
  
  
  // Rotate animation
  chart.animate({
    key: "rotationX",
    from: 0,
    to: 360,
    duration: 120000,
    loops: Infinity
  });
  
  
  // Make stuff animate on load
  chart.appear(1000, 100);
  
  }); // end am5.ready()
  document.getElementById('toggleGlobe').addEventListener('click', function() {
    var chartdiv = document.getElementById('chartdiv');
    var dashboard = document.getElementById('dashboard');
    var globeToFront = chartdiv.style.zIndex === '-1' || chartdiv.style.zIndex === '';
    chartdiv.style.zIndex = globeToFront ? '1001' : '-1';
    dashboard.style.zIndex = globeToFront ? '1000' : '1002';
    this.style.zIndex = '1003'; // Button stays on top
  });


    // If globe is brought to the front, ensure it spins
    if (globeToFront) {
      startSpinningGlobe();
    }

    // Optional: console logs to debug the current state
    console.log('Globe z-index:', chartdiv.style.zIndex);
    console.log('Dashboard z-index:', dashboard.style.zIndex);
    console.log('Button z-index:', this.style.zIndex);

function startSpinningGlobe() {
    // Check if chart is defined and handle spinning
    if (window.chart && (typeof window.chart.isSpinning === 'undefined' || !window.chart.isSpinning)) {
      window.chart.animate({
        key: "rotationX",
        from: window.chart.get("rotationX"),
        to: window.chart.get("rotationX") + 360,
        duration: 120000, // Adjusted for slower spin
        loops: Infinity
      });
      window.chart.isSpinning = true;  // Set spinning state
    }
}
</script>
<script>
  document.getElementById('reloadResults').addEventListener('click', function() {
    fetch('/trigger')
      .then(response => {
        // Handle the response if needed
      })
      .catch(error => {
        console.error('Error triggering the event:', error);
      });
  });
</script>
{% endblock %}