{% extends "base.html" %}
{% load custom_filters %}

{% block content %}

<style> 

  @keyframes spin { to { transform: rotate(360deg); } } 
  @keyframes color-change { 
    0% { border-top-color: #3498db; } 
    25% { border-top-color: #e74c3c; } 
    50% { border-top-color: #f1c40f; } 
    75% { border-top-color: #2ecc71; } 
    100% { border-top-color: #3498db; } 
  } 

  .spinner { 
    position: absolute; 
    justify-self: center; 
    top: 50%; 
    left: 50%; 
    transform: translate(-50%, -50%); 
    z-index: 1000; 
  } 

  .loader { 
    border: 5px solid #f3f3f3; 
    border-radius: 50%; 
    border-top: 5px solid #3498db; 
    width: 50px; 
    height: 50px; 
    animation: spin 2s linear infinite, color-change 4s ease-in-out infinite; 
  }

  /* Image display styles */
  .article-image {
    width: 100%;
    height: 80px; /* Set a fixed height, or adjust as needed */
    background-size: cover;
    background-position: center;
    border-radius: 8px;
    
  }

  #chartdiv {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh; /* Ensure it covers the full viewport height */
    z-index: -1; /* Initially in the background */
  }
  
  #dashboard {
    z-index: 1002; /* Initially in the foreground */
  }

  #toggleGlobe {
    z-index: 1003 !important;
    position: fixed; /* Fixed position */
    bottom: 20px; /* Positioning from bottom */
    right: 20px; /* Positioning from right */
  }
  @media (max-width: 768px) { /* Adjust this value based on your mobile breakpoint */
    .mobile-hide {
      display: none;
    }
  }
</style>

</style> 

<div id="chartdiv"></div> 

<h1 class="text-3xl font-bold text-gray-900 dark:text-white text-center my-4 opacity-90">Focus Dashboard</h1>

<div id="chartdiv"></div>
<button id="toggleGlobe" class="toggle-button bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full">Toggle Globe</button>
<div id="dashboard" class="container transparent mx-auto px-4 mt-4">
  <!-- Query Update Form -->
  <form method="POST" hx-post="{% url 'dashboard' %}" hx-target="#dashboard" hx-swap="innerHTML" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-6 gap-4">
    {% csrf_token %}
    {% for i in "12" %}
    {% with 'query'|add:i as query_attr %}
    <div class="bg-white/10 dark:bg-gray-900/10 backdrop-blur-xl rounded-lg shadow-lg p-4 opacity-90 {% if i == '1' %}md:col-span-3{% elif i == '2' %}md:col-span-3{% else %}mobile-hide{% endif %}">
      <label for="query{{ i }}" class="block text-sm font-medium text-gray-700 dark:text-gray-100">Searching news for:</label>
      <input type="text" id="query{{ i }}" name="query{{ i }}" value="{{ user_profile|getattr:query_attr }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 placeholder-gray-400 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white pl-2" placeholder="Enter query...">
    </div>
    {% endwith %}
    {% endfor %}
    <div class="col-start-2 col-span-4 flex justify-center mb-2">
      <button type="submit" class="mt-4 px-6 py-3 bg-gradient-to-r from-pink-400 via-pink-blue-500 to-green-500 text-white rounded-full shadow-lg transform transition-all hover:scale-105 hover:shadow-2xl focus:outline-none focus:ring-4 focus:ring-blue-300 dark:focus:ring-purple-600">
        Update Focus
      </button>
      <button id="reloadResults" type="button" class="mt-4 ml-4 px-6 py-3 bg-blue-500 text-white rounded-full shadow-lg transform transition-all hover:scale-105 hover:shadow-2xl focus:outline-none focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-600">
        Reload Results
      </button>
    </div>
  </form>

  <!-- TLDR Content Grid -->
  <div class="mt-4">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      {% for i in "12" %}
      {% with query_attr='query'|add:i %}
      <div class="bg-white dark:bg-gray-900 backdrop-blur-xl rounded-lg shadow-lg p-4 flex flex-col opacity-90">
        <div class="mb-2">
          <!-- <h3 class="text-lg font-semibold text-gray-900 dark:text-white">{{ user_profile|getattr:query_attr }}</h3> -->
          <div id="tldr-{{ i }}" hx-ext="sse" sse-connect="{% url 'tldr_sse' %}?query={{ user_profile|getattr:query_attr }}" sse-swap="tldr,issue_areas,contextualized_issue_areas,emoji_string">
            <div class="spinner spinner-{{ i }} hidden">
              <div class="loader"></div>
            </div>
            <!-- Content for TLDR will be loaded here -->
            {% include 'news/tldr_fragment.html' %}
          </div>
        </div>
      </div>
      {% endwith %}
      {% endfor %}
    </div>
  </div>
</div>

<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/map.js"></script>
<script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
<script> 
  document.body.addEventListener('htmx:beforeRequest', function(event) { 
    event.target.querySelector('.spinner').classList.remove('hidden'); 
  });

  document.body.addEventListener('htmx:afterRequest', function(event) {
    event.target.querySelector('.spinner').classList.add('hidden');
  });

  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      const context = this;
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(context, args), wait);
    };
  }
  const form = document.querySelector('form');
  form.addEventListener('submit', debounce(function() {
    // Submit the form
    this.submit();
  }, 300));
</script> 
<script>
  am5.ready(function() {
  
  // Create root element
  // https://www.amcharts.com/docs/v5/getting-started/#Root_element
  var root = am5.Root.new("chartdiv");
  
  
  // Set themes
  // https://www.amcharts.com/docs/v5/concepts/themes/
  root.setThemes([
    am5themes_Animated.new(root)
  ]);
  
  
  // Create the map chart
  // https://www.amcharts.com/docs/v5/charts/map-chart/
  var chart = root.container.children.push(am5map.MapChart.new(root, {
    panX: "rotateX",
    panY: "rotateY",
    projection: am5map.geoOrthographic(),
    paddingBottom: 20,
    paddingTop: 20,
    paddingLeft: 20,
    paddingRight: 20
  }));
  
  
  // Create main polygon series for countries
  // https://www.amcharts.com/docs/v5/charts/map-chart/map-polygon-series/
  var polygonSeries = chart.series.push(am5map.MapPolygonSeries.new(root, {
    geoJSON: am5geodata_worldLow
  }));
  
  polygonSeries.mapPolygons.template.setAll({
    tooltipText: "{name}",
    toggleKey: "active",
    interactive: true
  });
  
  polygonSeries.mapPolygons.template.states.create("hover", {
    fill: root.interfaceColors.get("primaryButtonHover")
  });
  
  
  // Create series for background fill
  // https://www.amcharts.com/docs/v5/charts/map-chart/map-polygon-series/#Background_polygon
  var backgroundSeries = chart.series.push(am5map.MapPolygonSeries.new(root, {}));
  backgroundSeries.mapPolygons.template.setAll({
    fill: root.interfaceColors.get("alternativeBackground"),
    fillOpacity: 0.1,
    strokeOpacity: 0
  });
  backgroundSeries.data.push({
    geometry: am5map.getGeoRectangle(90, 180, -90, -180)
  });
  
  
  // Create graticule series
  // https://www.amcharts.com/docs/v5/charts/map-chart/graticule-series/
  var graticuleSeries = chart.series.push(am5map.GraticuleSeries.new(root, {}));
  graticuleSeries.mapLines.template.setAll({ strokeOpacity: 0.1, stroke: root.interfaceColors.get("alternativeBackground") })
  
  
  // Rotate animation
  chart.animate({
    key: "rotationX",
    from: 0,
    to: 360,
    duration: 120000,
    loops: Infinity
  });
  
  
  // Make stuff animate on load
  chart.appear(1000, 100);
  
  }); // end am5.ready()
  document.getElementById('toggleGlobe').addEventListener('click', function() {
    var chartdiv = document.getElementById('chartdiv');
    var dashboard = document.getElementById('dashboard');
    var globeToFront = chartdiv.style.zIndex === '-1' || chartdiv.style.zIndex === '';
    chartdiv.style.zIndex = globeToFront ? '1001' : '-1';
    dashboard.style.zIndex = globeToFront ? '1000' : '1002';
    this.style.zIndex = '1003'; // Button stays on top
  });


    // If globe is brought to the front, ensure it spins
    if (globeToFront) {
      startSpinningGlobe();
    }

    // Optional: console logs to debug the current state
    console.log('Globe z-index:', chartdiv.style.zIndex);
    console.log('Dashboard z-index:', dashboard.style.zIndex);
    console.log('Button z-index:', this.style.zIndex);

function startSpinningGlobe() {
    // Check if chart is defined and handle spinning
    if (window.chart && (typeof window.chart.isSpinning === 'undefined' || !window.chart.isSpinning)) {
      window.chart.animate({
        key: "rotationX",
        from: window.chart.get("rotationX"),
        to: window.chart.get("rotationX") + 360,
        duration: 120000, // Adjusted for slower spin
        loops: Infinity
      });
      window.chart.isSpinning = true;  // Set spinning state
    }
}
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const eventSources = document.querySelectorAll('[sse-connect]');

  eventSources.forEach(function(eventSourceElement) {
    const eventSource = new EventSource(eventSourceElement.getAttribute('sse-connect'));

    eventSource.addEventListener('articles', function(event) {
      const articles = JSON.parse(event.data);
      const articlesOutput = eventSourceElement.querySelector('#articles-output');
      // Update articles output with received data
      articlesOutput.innerHTML = articles.map(article => `
        <div class="article-card">
          <h3>${article.source.name}</h3>
          <a href="${article.url}">
            <p>${article.title}</p>
          </a>
          <p>${article.content.slice(0, 200)}...</p>
        </div>
      `).join('');
    });

    eventSource.addEventListener('tldr', function(event) {
      const tldr = JSON.parse(event.data).tldr;
      const tldrOutput = eventSourceElement.querySelector('#tldr-output');
      tldrOutput.innerHTML = tldr;
    });

    eventSource.addEventListener('issue_areas', function(event) {
      const issueAreas = JSON.parse(event.data);
      const issueAreasOutput = eventSourceElement.querySelector('.issue-areas .grid');
      issueAreasOutput.innerHTML = issueAreas.map(issueArea => `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-2">
          <h5 class="text-xs font-semibold text-gray-900 dark:text-fluorescent-green">${issueArea.name}</h5>
          <p class="mt-1 text-xs text-gray-700 dark:text-gray-300">${issueArea.description}</p>
        </div>
      `).join('');
    });

    eventSource.addEventListener('contextualized_issue_areas', function(event) {
      const contextualizedIssueAreas = JSON.parse(event.data).context;
      const contextualizedOutput = eventSourceElement.querySelector('#tldr-output');
      contextualizedOutput.innerHTML = contextualizedIssueAreas;
    });

    eventSource.addEventListener('emoji_string', function(event) {
      const emojiString = JSON.parse(event.data).emojis;
      const emojiOutput = eventSourceElement.querySelector('#emoji-output');
      emojiOutput.textContent = `Emoji Quicksight: ${emojiString.slice(0, 7)}`;
    });

    eventSource.addEventListener('error', function(event) {
      if (eventSource.readyState === EventSource.CLOSED) {
        console.error("SSE connection closed");
      }
    });

    eventSource.addEventListener('open', function(event) {
      console.log("SSE connection opened");
    });

    eventSource.addEventListener('message', function(event) {
      console.log("Received message:", event.data);
    });
  });
});
</script>
<script>
document.getElementById('reloadResults').addEventListener('click', function() {
  location.reload();
});
</script>
{% endblock %}